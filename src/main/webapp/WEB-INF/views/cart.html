<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Giỏ hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/alpinejs" defer></script>
</head>

<style>[x-cloak] { display: none !important; }</style>

<body class="bg-gray-100 font-['Roboto'] min-h-screen flex flex-col" style="padding-top: 82px">

<!-- Header -->
<div th:replace="/fragments :: header"></div>

<main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-40">

    <!-- Bảng giỏ hàng -->
    <div class="flex flex-col lg:flex-row gap-6 items-start">
        <div class="bg-white rounded-xl shadow-md overflow-x-auto w-full lg:w-[calc(100%-22rem)]">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-orange-500 text-white">
                <tr>
                    <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAll" class="form-checkbox h-4 w-4" /></th>
                    <th class="px-4 py-3 text-left">Image</th>
                    <th class="px-4 py-3 text-left">Name of product</th>
                    <th class="px-4 py-3 text-center">Quantity</th>
                    <th class="px-4 py-3 text-right">Price</th>
                    <th class="px-4 py-3 text-right">Into money</th>
                    <th class="px-4 py-3 text-center">Action</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                <tr th:each="item : ${cartItems}" class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 text-center">
                        <input type="checkbox" class="item-checkbox"
                               th:name="selectedItems"
                               th:value="${item.product.id}"
                               th:attr="data-quantity=${item.quantity}, data-price=${item.product.price}" />
                    </td>
                    <td class="px-4 py-3">
                        <img th:src="${item.product.imageUrl}" alt="Ảnh sản phẩm" class="w-16 h-16 object-contain rounded-md mx-auto" />
                    </td>
                    <td class="px-4 py-3 text-gray-800 font-medium" th:text="${item.product.name}">Tên sản phẩm</td>
                    <td class="px-4 py-3 text-center text-gray-700" th:text="${item.quantity}">1</td>
                    <td class="px-4 py-3 text-right text-gray-700" th:text="${item.product.price} + ' $'">100$</td>
                    <td class="px-4 py-3 text-right text-blue-600 font-semibold" th:text="${item.quantity * item.product.price} + ' $'">100$</td>
                    <td class="px-4 py-3 text-center" x-data="{ showModal: false }">
                        <button @click="showModal = true" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash-alt mr-1"></i>
                        </button>

                        <!-- Modal xác nhận xoá -->
                        <div x-show="showModal" x-cloak
                             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-all duration-200"
                             @click.self="showModal = false">
                            <div class="bg-white rounded-lg p-6 shadow-lg max-w-sm w-full">
                                <h3 class="text-lg font-semibold mb-4 text-gray-800">Confirm deletion</h3>
                                <p class="text-gray-600 mb-6">Are you sure you want to delete this product?</p>
                                <div class="flex justify-end space-x-4">
                                    <button @click="showModal = false"
                                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancle</button>
                                    <form method="post" th:action="@{/cartController/remove/{id}(id=${item.product.id})}">
                                        <button type="submit"
                                                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Order Summary -->
            <div class="bg-white rounded-xl shadow-md p-6 w-full lg:w-80">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Order Summary</h2>
                <div class="text-gray-700 text-sm space-y-2">
                    <div class="flex justify-between">
                        <span>Selected Items:</span>
                        <span id="totalItems">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Tax (10%):</span>
                        <span id="tax">$0</span>
                    </div>
                    <div id="checkoutSection" class="mt-4 space-y-4">
                        <div class="border-t pt-2 flex justify-between font-semibold text-gray-900">
                            <span>Total:</span>
                            <span id="totalAmount">$0</span>
                        </div>
                        <form th:action="@{/orders/checkout-info}" method="get" id="checkoutForm">
                            <input type="hidden" name="selectedIds" id="selectedIds" />
                            <button type="button" onclick="submitCheckout()"
                                    class="w-full inline-flex items-center justify-center px-5 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-medium transition">
                                <i class="fas fa-credit-card mr-2"></i> Buy now
                            </button>
                        </form>
                    </div>

                </div>
    </div>
        </div>
</main>

<!-- Footer -->
<div th:replace="/fragments :: footer"></div>

<!-- ✅ Toast thành công -->
<div x-data="{ show: true }"
     x-init="setTimeout(() => show = false, 3000)"
     x-show="show"
     x-transition
     th:if="${successMessage}"
     class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-800 px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 z-50">
    <i class="fas fa-check-circle text-xl"></i>
    <p class="text-base font-semibold" th:text="${successMessage}">Thành công!</p>
    <button @click="show = false" class="ml-auto text-green-700 hover:text-green-900">
        <i class="fas fa-times"></i>
    </button>
</div>

<!-- ❌ Toast lỗi -->
<div x-data="{ show: true }"
     x-init="setTimeout(() => show = false, 3000)"
     x-show="show"
     x-transition
     th:if="${errorMessage}"
     class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-800 px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 z-50">
    <i class="fas fa-times-circle text-xl"></i>
    <p class="text-base font-semibold" th:text="${errorMessage}">Có lỗi xảy ra!</p>
    <button @click="show = false" class="ml-auto text-red-700 hover:text-red-900">
        <i class="fas fa-times"></i>
    </button>
</div>

<!-- ⚠️ Toast cảnh báo khi chưa chọn sản phẩm -->
<div id="toastWarning"
     class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-yellow-100 border border-yellow-400 text-yellow-800 px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 z-50">
    <i class="fas fa-exclamation-triangle text-xl"></i>
    <span class="text-sm font-medium">Please select at least one item to checkout.</span>
</div>

<!-- Modal xác nhận logout -->
<div id="logoutModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-80 text-center animate-fade-in">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
            Are you sure you want to log out?
        </h2>
        <div class="flex justify-center gap-4">
            <a href="/user/logout"
               class="px-4 py-2 rounded-md bg-orange-500 text-white hover:bg-orange-600 transition duration-200">
                Logout
            </a>
            <button onclick="closeLogoutModal()"
                    class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-200">
                Cancel
            </button>
        </div>
    </div>
</div>


<script>
    function openLogoutModal(event) {
        event.preventDefault();
        document.getElementById('logoutModal').classList.remove('hidden');
    }

    function closeLogoutModal() {
        document.getElementById('logoutModal').classList.add('hidden');
    }

    // Optional: đóng khi click nền đen
    document.addEventListener('click', function (e) {
        const modal = document.getElementById('logoutModal');
        if (!modal.classList.contains('hidden') && e.target === modal) {
            closeLogoutModal();
        }
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectAllCheckbox = document.getElementById("selectAll");
        const itemCheckboxes = document.querySelectorAll(".item-checkbox");
        const totalAmountSpan = document.getElementById("totalAmount");
        const totalItemsSpan = document.getElementById("totalItems");
        const subtotalSpan = document.getElementById("subtotal");
        const taxSpan = document.getElementById("tax");

        function updateTotals() {
            let total = 0;
            let subtotal = 0;
            let totalItems = 0;

            itemCheckboxes.forEach(cb => {
                if (cb.checked) {
                    const quantity = parseInt(cb.dataset.quantity);
                    const price = parseFloat(cb.dataset.price);
                    totalItems += quantity;
                    subtotal += quantity * price;
                }
            });

            const tax = subtotal * 0.1;
            total = subtotal + tax;

            totalItemsSpan.textContent = totalItems;
            subtotalSpan.textContent = formatPrice(subtotal);
            taxSpan.textContent = formatPrice(tax);
            totalAmountSpan.textContent = formatPrice(total);

            // ✅ Ẩn/hiện dòng tổng tiền + nút checkout
            const checkoutSection = document.getElementById("checkoutSection");
            if (totalItems > 0) {
                checkoutSection.classList.remove("hidden");
            } else {
                checkoutSection.classList.add("hidden");
            }
        }

        function formatPrice(value) {
            value = Math.floor(value * 100) / 100;
            return `$${value.toFixed(2)}`;
        }

        function updateSelectAllState() {
            const allChecked = Array.from(itemCheckboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        }

        selectAllCheckbox.addEventListener("change", function () {
            itemCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateTotals();
        });

        itemCheckboxes.forEach(cb => {
            cb.addEventListener("change", () => {
                updateTotals();
                updateSelectAllState();
            });
        });

        updateTotals();
        updateSelectAllState();
    });


    function submitCheckout() {
        const selected = Array.from(document.querySelectorAll(".item-checkbox"))
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        if (selected.length === 0) {
            const toast = document.getElementById("toastWarning");
            toast.classList.remove("hidden");
            setTimeout(() => toast.classList.add("hidden"), 3000);
            return;
        }

        document.getElementById("selectedIds").value = selected.join(",");
        document.getElementById("checkoutForm").submit();
    }


        function openLogoutModal(event) {
        event.preventDefault();
        document.getElementById('logoutModal').classList.remove('hidden');
    }

        function closeLogoutModal() {
        document.getElementById('logoutModal').classList.add('hidden');
    }

        // Optional: đóng khi click nền đen
        document.addEventListener('click', function (e) {
        const modal = document.getElementById('logoutModal');
        if (!modal.classList.contains('hidden') && e.target === modal) {
        closeLogoutModal();
    }
    });
</script>

</body>

</html>
