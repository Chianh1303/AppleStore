<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Giỏ hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
</head>
<body class="bg-gray-100 font-['Roboto'] min-h-screen flex flex-col">

<!-- Header -->
<div th:replace="/fragments :: header"></div>

<main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Tiêu đề -->
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Giỏ hàng</h1>

    <!-- Bảng giỏ hàng -->
    <div class="bg-white rounded-xl shadow-md overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-blue-600 text-white">
            <tr>
                <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAll" class="form-checkbox h-4 w-4" onclick="toggleAllCheckboxes(this)" /></th>
                <th class="px-4 py-3 text-left">Ảnh</th>
                <th class="px-4 py-3 text-left">Tên sản phẩm</th>
                <th class="px-4 py-3 text-center">Số lượng</th>
                <th class="px-4 py-3 text-right">Giá</th>
                <th class="px-4 py-3 text-right">Thành tiền</th>
                <th class="px-4 py-3 text-center">Thao tác</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
            <tr th:each="item : ${cartItems}" class="hover:bg-gray-50 transition">
                <td class="px-4 py-3 text-center">
                    <input type="checkbox" class="item-checkbox" th:name="selectedItems" th:value="${item.product.id}" />
                </td>
                <td class="px-4 py-3">
                    <img th:src="${item.product.imageUrl}" alt="Ảnh sản phẩm" class="w-16 h-16 object-contain rounded-md mx-auto" />
                </td>
                <td class="px-4 py-3 text-gray-800 font-medium" th:text="${item.product.name}">Tên sản phẩm</td>
                <td class="px-4 py-3 text-center text-gray-700" th:text="${item.quantity}">1</td>
                <td class="px-4 py-3 text-right text-gray-700" th:text="${item.product.price} + ' $'">100$</td>
                <td class="px-4 py-3 text-right text-blue-600 font-semibold" th:text="${item.quantity * item.product.price} + ' $'">100$</td>
                <td class="px-4 py-3 text-center">
                    <a th:href="@{/cartController/remove/{id}(id = ${item.product.id})}" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash-alt mr-1"></i> Xóa
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Tổng tiền và nút đặt hàng -->
    <div class="mt-6 flex flex-col md:flex-row justify-between items-center">
        <div class="text-xl font-bold text-gray-800">
            Tổng cộng: <span id="totalAmount">$0</span>
        </div>
        <form th:action="@{/orders/checkout}" method="post" id="checkoutForm">
            <input type="hidden" name="selectedIds" id="selectedIds" />
            <button type="button" onclick="submitCheckout()"
                    class="mt-3 md:mt-0 inline-flex items-center px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                <i class="fas fa-credit-card mr-2"></i> Đặt hàng
            </button>
        </form>


    </div>
</main>

<!-- Footer -->
<div th:replace="/fragments :: footer"></div>

<!-- Thông báo thành công -->
<div th:if="${successMessage}" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-green-100 text-green-700 px-4 py-2 rounded shadow-md">
    <p th:text="${successMessage}"></p>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectAllCheckbox = document.getElementById("selectAll");
        const itemCheckboxes = document.querySelectorAll(".item-checkbox");
        const totalAmountSpan = document.getElementById("totalAmount");

        function getItemTotalAmount(row) {
            const quantity = parseInt(row.querySelector("td:nth-child(4)").textContent.trim()) || 0;
            const priceText = row.querySelector("td:nth-child(5)").textContent.trim().replace(/[^\d.]/g, "");
            const price = parseFloat(priceText) || 0;
            return quantity * price;
        }

        function formatPrice(value) {
            value = Math.floor(value * 100) / 100;
            return value % 1 === 0
                ? `$${value.toFixed(0)}`
                : `$${value.toFixed(2)}`;
        }

        function updateTotalAmount() {
            const rows = document.querySelectorAll("tbody tr");
            let total = 0;

            rows.forEach((row) => {
                const checkbox = row.querySelector(".item-checkbox");
                const itemAmount = getItemTotalAmount(row);
                if (checkbox.checked) {
                    total += itemAmount;
                }
            });

            totalAmountSpan.textContent = formatPrice(total);
        }

        selectAllCheckbox.addEventListener("change", function () {
            itemCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateTotalAmount();
        });

        itemCheckboxes.forEach(cb => {
            cb.addEventListener("change", function () {
                const allChecked = Array.from(itemCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                updateTotalAmount();
            });
        });

        updateTotalAmount();
    });

    document.getElementById("checkoutForm").addEventListener("submit", function (e) {
        const selected = Array.from(document.querySelectorAll(".item-checkbox"))
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        document.getElementById("selectedIds").value = selected.join(",");
    });

    function submitCheckout() {
        const selected = Array.from(document.querySelectorAll(".item-checkbox"))
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        if (selected.length === 0) {
            alert("Vui lòng chọn ít nhất một sản phẩm để đặt hàng.");
            return;
        }

        document.getElementById("selectedIds").value = selected.join(",");
        document.getElementById("checkoutForm").submit();
        console.log("Đã mua sản phẩm  : " + selected);
    }

</script>
</body>
</html>
